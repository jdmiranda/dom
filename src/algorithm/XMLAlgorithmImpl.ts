import { XMLAlgorithm, DOMAlgorithm } from './interfaces'
import { SubAlgorithmImpl } from './SubAlgorithmImpl'

/**
 * Contains event algorithms.
 */
export class XMLAlgorithmImpl extends SubAlgorithmImpl implements XMLAlgorithm {

  protected static readonly NameStartChar = /[:A-Z_a-z\xC0-\xD6\xD8-\xF6\xF8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF]/
  protected static readonly NameChar = /[\x2D\.0-:A-Z_a-z\xB7\xC0-\xD6\xD8-\xF6\xF8-\u037D\u037F-\u1FFF\u200C\u200D\u203F\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF]/
  protected static readonly Name = /^([:A-Z_a-z\xC0-\xD6\xD8-\xF6\xF8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])([\x2D\.0-:A-Z_a-z\xB7\xC0-\xD6\xD8-\xF6\xF8-\u037D\u037F-\u1FFF\u200C\u200D\u203F\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])*$/
  protected static readonly NCName = /^([A-Z_a-z\xC0-\xD6\xD8-\xF6\xF8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])([\x2D\.0-9A-Z_a-z\xB7\xC0-\xD6\xD8-\xF6\xF8-\u037D\u037F-\u1FFF\u200C\u200D\u203F\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])*$/
  protected static readonly QName = /^(([A-Z_a-z\xC0-\xD6\xD8-\xF6\xF8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])([\x2D\.0-9A-Z_a-z\xB7\xC0-\xD6\xD8-\xF6\xF8-\u037D\u037F-\u1FFF\u200C\u200D\u203F\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])*:([A-Z_a-z\xC0-\xD6\xD8-\xF6\xF8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])([\x2D\.0-9A-Z_a-z\xB7\xC0-\xD6\xD8-\xF6\xF8-\u037D\u037F-\u1FFF\u200C\u200D\u203F\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])*)|(([A-Z_a-z\xC0-\xD6\xD8-\xF6\xF8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])([\x2D\.0-9A-Z_a-z\xB7\xC0-\xD6\xD8-\xF6\xF8-\u037D\u037F-\u1FFF\u200C\u200D\u203F\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])*)$/
  protected static readonly PubidChar = /^[\x20\x0D\x0AA-Z-a-z0-9-'()+,./:=?;!*#@$_%]*$/

  /** 
   * Valid characters for XML 1.0 from https://www.w3.org/TR/xml/#charsets.
   * 
   * Any Unicode character, excluding the surrogate blocks, `FFFE`, and `FFFF`.
   * 
   * `#x9 | #xA | #xD | [#x20-#xD7FF] | [#xE000-#xFFFD] | [#x10000-#x10FFFF]`
   * 
   * This ES5 compatible Regexp has been generated using the `"regenerate"` NPM
   * module:
   * ```ts
   * let xml_10_InvalidChars = regenerate()
   *   .addRange(0x0000, 0x0008)
   *   .add(0x000B, 0x000C)
   *   .addRange(0x000E, 0x001F)
   *   .addRange(0xD800, 0xDFFF)
   *   .addRange(0xFFFE, 0xFFFF)
   * ```
   */
  protected static readonly InvalidChar_10 = /[\0-\x08\x0B\f\x0E-\x1F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/

  /**
   * Valid characters for XML 1.1 from https://www.w3.org/TR/xml11/#charsets.
   * 
   * Any Unicode character, excluding the surrogate blocks, `FFFE`, and `FFFF`.
   * 
   * `[#x1-#xD7FF] | [#xE000-#xFFFD] | [#x10000-#x10FFFF]`
   * 
   * This ES5 compatible Regexp has been generated using the `"regenerate"` NPM
   * module:
   * ```ts
   * let xml_11_InvalidChars = regenerate()
   *   .add(0x0000)
   *   .addRange(0xD800, 0xDFFF)
   *   .addRange(0xFFFE, 0xFFFF)
   * ```
   */
  protected static readonly InvalidChar_11 = /[\0\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/

  /**
   * Initializes a new `XMLAlgorithm`.
   * 
   * @param algorithm - parent DOM algorithm
   */
  public constructor(algorithm: DOMAlgorithm) {
    super(algorithm)
  }

  /** @inheritdoc */
  isName(name: string): boolean {
    return XMLAlgorithmImpl.Name.test(name)
  }

  /** @inheritdoc */
  isQName(name: string): boolean {
    return XMLAlgorithmImpl.QName.test(name)
  }

  /** @inheritdoc */
  isLegalChar(chars: string, xmlVersion: "1.0" | "1.1" = "1.0"): boolean {
    if (xmlVersion === "1.0") {
      return (!XMLAlgorithmImpl.InvalidChar_10.test(chars))
    } else {
      return (!XMLAlgorithmImpl.InvalidChar_11.test(chars))
    }
  }


  /** @inheritdoc */
  isPubidChar(chars: string): boolean {
    return XMLAlgorithmImpl.PubidChar.test(chars)
  }

}
